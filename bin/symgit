#!/usr/bin/env bash

. lib.bash || exit

host=star
fsroot='/srv/git'
urlprefix=':'

klist -s || kinit || die "no Kerberos credentials"

cmd=$1; shift

case ${cmd:-help} in
	help)
		echo "Commands:"
		echo "  ls|list"
		echo "  new <repo>..."
		echo "  mv|rename <old_repo> <new_repo>"
		echo "  exp|export <repo>..."
		echo "  unexp|unexport <repo>..."
		;;
	ls|list)
		if (( $# )); then
			die "extraneous arguments: '$*'"
		fi
		ssh $host "find '$fsroot/' -type d -name '*.git' -printf '%P\n' -prune" \
			| sort \
			| sed "s|^|$urlprefix|; s|\\.git\$||"
		;;
	new)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			dir=$fsroot/$arg
			url=$urlprefix${arg%.git}
			if ssh $host "test -d ${dir@Q}"; then
				err "repository '$url' already exists"
				continue
			fi
			info "creating repository '$url'"
			ssh $host "git init --bare ${dir@Q}"
			ssh $host "chmod go-rx ${dir@Q}"
		done
		;;
	mv|move|rename)
		if (( $# != 2 )); then
			die "Usage: $progname $cmd <old> <new>"
		fi
		old=${1%.git}.git; olddir=$fsroot/$old; oldu=$urlprefix${old%.git}
		new=${2%.git}.git; newdir=$fsroot/$new; newu=$urlprefix${new%.git}
		if ! ssh $host "test -d ${olddir@Q}"; then
			err "source repository '$oldu' does not exist"
		elif ssh $host "test -d ${newdir@Q}"; then
			err "target repository '$newu' already exists"
		else
			info "renaming repository '$oldu' => '$newu'"
			ssh $host "mv -Tvn ${olddir@Q} ${newdir@Q}"
		fi
		;;
	pub|publish|exp|export)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			dir=$fsroot/$arg
			url=$urlprefix${arg%.git}
			if ! ssh $host "test -d ${dir@Q}"; then
				err "repository '$url' does not exist"
				continue
			elif ssh $host "test -f ${dir@Q}/git-daemon-export-ok"; then
				info "repository '$url' already public"
				continue
			fi
			info "publishing repository '$url'"
			ssh $host "touch ${dir@Q}/git-daemon-export-ok"
			ssh $host "chmod a+rx ${dir@Q}"
		done
		;;
	unpub|unpublish|unexp|unexport)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			dir=$fsroot/$arg
			url=$urlprefix${arg%.git}
			if ! ssh $host "test -d ${dir@Q}"; then
				err "repository '$url' does not exist"
				continue
			fi
			info "unpublishing repository '$url'"
			ssh $host "rm -f ${dir@Q}/git-daemon-export-ok"
			ssh $host "chmod go-rx ${dir@Q}"
		done
		;;
esac

lib::exit
