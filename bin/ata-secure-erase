#!/usr/bin/env bash

. lib.bash || exit

force_tran=die
enhanced=''

if [[ $SUDO_UID ]]; then
	notify-send() {
		sudo -u "#$SUDO_UID" \
			XDG_RUNTIME_DIR="/run/user/$SUDO_UID" \
			notify-send "$@"
	}
fi

while getopts ":EF" OPT; do
	case $OPT in
	F) force_tran=warn;;
	E) enhanced='-enhanced';;
	*) lib::die_getopts;;
	esac
done; shift $((OPTIND-1))

dev=$1
[[ -b $dev ]] || die "path '$dev' is not a block device"
[[ -w $dev ]] || die "no write permission for '$dev'"

tran=$(lsblk -Sno TRAN "$dev")
[[ $tran == usb ]] || $force_tran "disk '$dev' is not USB-attached ($tran)"

#buf=$(head -c 4096 "$dev" | xxd -p | sed 's/00//g' | tr -d '\n')
#[[ $buf ]] && warn "disk '$dev' is not empty (buf)"

buf=$(wipefs -p "$dev")
[[ $buf ]] && warn "disk '$dev' is not empty"

log "device identification:"
lsblk -S "$dev"

log "device contents:"
lsblk -o +FSTYPE,LABEL "$dev"

log "ATA information:"
hdparm -I "$dev" | awk 'x&&/^[^\t]/{x=0} /^(Security:|ATA device,)/{x=1} x{print}'

if ! hdparm -I "$dev" | grep -qs '^Security:'; then
	die "disk '$dev' does not support ATA SECURITY ERASE"
fi

minutes=$(hdparm -I "$dev" | if [[ $enhanced ]]; then
	sed -E -n 's/.* ([0-9]+)min for ENHANCED SECURITY ERASE UNIT.*/\1m/p'
else
	sed -E -n 's/^ ([0-9]+)min for SECURITY ERASE.*/\1m/p'
fi)

confirm "erase '$dev'?" || exit

attrib="/tmp/${dev//'/'/'_'}"
do: smartctl -A "$dev" | tee "$attrib-old.txt"

pwd="foo"
info "setting ATA password of '$dev' to '$pwd'"
do: hdparm --security-set-pass "$pwd" "$dev"
info "activating ATA erase of '$dev' (expected duration: $minutes)"
Tstart=$(date +%s); date -d "@$Tstart" +"started at %c"
for part in {1..15}; do
	if [[ -e $dev$part ]]; then
		umount "$dev$part" || true
		partx --delete --nr "$part" "$dev"
	fi
done
#do: partx --delete "$dev" || exit

hdparm --security-erase$enhanced "$pwd" "$dev" & erase_pid=$!
countdown "$minutes" & countdown_pid=$!
wait -n -p pid; r=$?
if [[ $pid == $erase_pid ]]; then
	kill $countdown_pid
	echo "hdparm finished"
else
	echo "hdparm still running..."
	wait -n
fi

Tfinish=$(date +%s); date -d "@$Tfinish" +"finished at %c"
info "erase took $(interval $[Tfinish-Tstart])"
notify-send "Security erase of '$dev' complete in $(interval $[Tfinish-Tstart])."

info "erase done"
do: hdparm -I "$dev" | awk '/^Security:/{x=1} /^[^S\t]/{x=0} x{print}'
do: smartctl -A "$dev" | tee "$attrib-new.txt"
colordiff -u "$attrib-old.txt" "$attrib-new.txt" || true
do: scsi_stop "$dev"
