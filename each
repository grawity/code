#!/usr/bin/env bash
# each -- reverse xargs
#
# Syntax not set in stone yet.
#
# Usage 1:
#
#   - for x in one two three; do frob "$x"; done
#   + each frob -- one two three
#
# Usage 2:
#
#   - find ./foo/ | xargs -I -d '\n' frob {}
#   + find ./foo/ | each frob

args=()
cmd=()
flag=0

if [[ -t 0 ]]; then
	# Find the *last* double-dash arg
	ldash=0
	for (( i=1; i<=$#; i++ )); do
		if [[ ${!i} == "--" ]]; then
			ldash=$i
		fi
	done
	if (( !ldash )); then
		echo "each: args must be specified" >&2
		exit 2
	fi

	# Collect "cmd -- args"
	for (( i=1; i<=$#; i++ )); do
		if (( i < ldash )); then
			cmd+=("${!i}")
		elif (( i == ldash )); then
			continue
		else
			args+=("${!i}")
		fi
	done

	for arg in "${args[@]}"; do
		"${cmd[@]}" "$arg"
	done
else
	for arg; do
		cmd+=("$arg")
	done

	while IFS= read -r arg; do
		"${cmd[@]}" "$arg" </dev/tty
	done
fi
