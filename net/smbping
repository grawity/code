#!/usr/bin/env python3
import argparse
from pprint import pprint
import smbclient

parser = argparse.ArgumentParser()
parser.add_argument("target",
                    help="server hostname to ping, or UNC path to list",
                    nargs="+")
args = parser.parse_args()

for target in args.target:
    target = target.replace("/", "\\")
    if target.startswith(r"\\"):
        try:
            result = smbclient.listdir(target)
            print("Contents of %s:" % target)
            pprint(sorted(result))
        except Exception as e:
            exit("Failed to connect to \"%s\": %r" % (target, e))
    else:
        try:
            sess = smbclient.register_session(target)
            print("Connected via SMB to \"%s\" using %r." % (sess.connection.server_name,
                                                             sess.auth_protocol))
        except Exception as e:
            exit("Failed to connect to \"%s\": %r" % (target, e))

# It would be useful to list available shares when "\\foo" is provided, but
# apparently this involves some relatively complex RPC to the SRVSVC pipe,
# rather than being directly available at SMB level.
