#!/usr/bin/env bash

. lib.bash || exit

. $path_config/synced/irc.conf || exit

do_fifo() {
	echo "$*" | ssh $irc_host 'cat > .weechat/weechat_fifo*'
}

if [[ $1 == -- ]]; then
	shift
	do_fifo "*$*"
	exit
elif [[ $1 == /* ]]; then
	do_fifo "*$*"
	exit
fi

export MOSH_TITLE_NOPREFIX='y'

lock=$path_runtime/irc-$XDG_SESSION_ID.lock
exec {fd}<>"$lock"
flock -xn $fd || die "already connected from $HOSTNAME/$XDG_SESSION_ID"

mosh $irc_host -- tmux attach -t irc; r=$?

hi >&/dev/null {fd}>&- &

rm -f "$lock"
exit $r
