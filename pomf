#!/usr/bin/env bash
# vim: ts=4:sw=4:et

. lib.bash || exit

curl_args=()
for f in "$@"; do
    if [[ -e "$f" ]]; then
        curl_args+=(-F "files[]=@$f")
    else
        err "file '$f' not found"
    fi
done
if (( ! ${#curl_args[@]} )); then
    die "nothing to upload"
fi
if [[ -t 2 ]]; then
    curl_args+=(-#)
fi

upload=$(curl -S "${curl_args[@]}" https://pomf.se/upload.php)
urls=$(jshon -e files -a -e name -upe url -u <<< "$upload")
clip=()
while {
    read -r name
    read -r url
} do
    url=https://a.pomf.se/$url
    printf '%s: %s\n' "$name" "$url"
    clip+=("$url")
done <<< "$urls"

if [[ "$DISPLAY" ]] && (( ${#clip[@]} )); then
    echo -n "${clip[*]}" | xsel -i -b
fi

(( ! errors ))
