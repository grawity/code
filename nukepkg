#!/usr/bin/env bash

. lib.bash || exit

do:() { (PS4='+ '; set -x; "$@") }

sudo:() {
	if (( UID ))
		then do: sudo "$@"
		else do: "$@"
	fi
}

dir=$XDG_CACHE_HOME/bacman

mkdir -p "$dir" || exit
cd "$dir"       || exit

for pkg; do
	sudo: bacman "$pkg"
done

orphans_before=$(mktemp /tmp/nukepkg.XXXXXXXX)
orphans_after=$(mktemp /tmp/nukepkg.XXXXXXXX)

pacman -Qqdt | sort > "$orphans_before"
sudo: pacman -Rn "$@"
pacman -Qqdt | sort > "$orphans_after"

new_orphans=$(comm -13 "$orphans_before" "$orphans_after")
if [[ $new_orphans ]]; then
	echo "New orphans: $new_orphans"
fi

rm -f "$orphans_before" "$orphans_after"
