#!/usr/bin/env bash
# asplog -- show changelog for an Arch Linux package
#
# Previously (before GitLab migration) this was a wrapper around the svn2git
# `asp log` tool.

basedir="${XDG_CACHE_HOME:-$HOME/.cache}/asp"
if [[ ! -d $basedir ]]; then
	mkdir -p "$basedir"
fi

#if [[ -d $basedir/cache ]]; then
#	echo "Removing old svn2git cache"
#	rm -rf "$basedir/cache"
#fi

pkg=$1

# Fix up tab-completion
pkg=${pkg#*/}

# Look up pkgbase if a binary package is specified
pkg=$(expac -S -1 %e "$pkg" || echo "$pkg")
echo "${0##*/}: using '$pkg' as source name"

url="https://gitlab.archlinux.org/archlinux/packaging/packages/$pkg.git"

if [[ ! -d $basedir/$pkg ]]; then
	git clone "$url" "$basedir/$pkg"
else
	git -C "$basedir/$pkg" pull --ff-only
fi

settitle "asplog [$pkg]"

tig -C "$basedir/$pkg"
