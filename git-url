#!/usr/bin/env bash

. lib.bash || exit

base=$(git config --get web.url)
type=$(git config --get web.type)
head=$(git rev-parse --short=12 HEAD)

if [[ ! $base ]]; then
	remote=$(git remote get-url origin)
	case $remote in
		https://github.com/*)
			base=${remote%.git}
			type=github
			;;
		https://gitlab.gnome.org/*)
			base=${remote%.git}
			type=gitlab
			;;
	esac
fi

if [[ ! $type ]]; then
	case $base in
	https://github.com/*)
		type='github';;
	https://gitlab.gnome.org/*)
		type='gitlab';;
	*/cgit/*)
		type='cgit';;
	esac
fi

if [[ ! $type ]]; then
	die "unknown type for url '$base'"
fi

toplevel=$(git rev-parse --show-toplevel)
prefix=$(git rev-parse --show-prefix)
debug "repo toplevel: '$toplevel'"
debug "repo prefix: '$prefix'"

base=${base%/}
debug "base: '$base'"

is_file() {
	if [[ $(git config core.bare) == true ]]; then
		git rev-parse --verify "HEAD:/$1" >& /dev/null
	else
		[[ -e "$1" ]]
	fi
}

for arg; do
	debug "arg: '$arg'"

	if [[ $arg == @(pr|pull)/* ]]; then
		mode=pull
		arg=${arg#*/}
	elif [[ $arg == @(bug|issue)/* ]]; then
		mode=issue
		arg=${arg#*/}
	elif t=$(git rev-parse --short=20 "$arg") && [[ $t ]]; then
		: ${mode:=commit}
		head=$t
	elif t=$prefix$arg && is_file "$arg"; then
		debug "looking for file '$t'"
		: ${mode:=file}
		path=$t
	fi

	if [[ ! $mode ]]; then
		err "cannot understand arg '$arg'"
		continue
	fi

	debug "arg '$arg' is a $mode"

	case $type in
	'cgit')
		case $mode in
		'log')    url="$base/log/$path?h=$head";; # TODO: make this global log
		'flog')   url="$base/log/$path?h=$head";;
		'file')   url="$base/tree/$path?h=$head";;
		'commit') url="$base/commit/?id=$head";;
		esac;;
	'github')
		case $mode in
		'log')    url="$base/commits/$head";;
		'flog')   url="$base/commits/$head/$path";;
		'file')   url="$base/blob/$head/$path";;
		'commit') url="$base/commit/$head";;
		esac;;
	'gitlab')
		case $mode in
			issue)	url="$base/issues/$arg";;
			pull)	url="$base/merge_requests/$arg";;
		esac;;
	'gitweb')
		base=${base//";a=summary"/}
		case $mode in
		'log')    url="$base;a=shortlog;h=$head";;
		'flog')   url="$base;a=history;f=$path;h=$head";;
		'file')   url="$base;a=blob;f=$path;h=$head";;
		'commit') url="$base;a=commit;h=$head";;
		*)        die "$type not yet implemented";;
		esac;;
	esac

	[[ $url ]] || die "$type/$mode not yet implemented"

	echo "$url"
done
