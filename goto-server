#!/usr/bin/env bash
# go - quick connection script

. lib.bash || exit

progname='goto-server'

usage() {
	echo "Usage: $progname <host>"
}

cd ~

if [[ $0 != */@(go|goto-server|@) ]]; then
	set -- "${0##*/}" "$@"
fi

if [[ ! $1 ]]; then
	usage >&2
	die "missing host name"
fi

lib::find_file server_list= ~/lib/servers.txt config:servers.txt \
	|| die "server list '$server_list' not found"

name="$1"
if [[ $2 && $2 != /* ]]; then
	name+="-$2"; shift
fi
debug "looking for name '$name'"

ip= rest=
while read -r _name _ip _rest; do
	if [[ $name == "$_name" ]]; then
		ip=$_ip
		rest=$_rest
	fi
done < "$server_list"
debug "resulting ip='$ip' rest='$rest'"

case $ip in
    imap://*|imaps://*)
	mutt -f "$ip$2" $rest;;
    rdp://*)
	mstsc "${ip#rdp://}" $rest;;
    *://*)
	die "unknown protocol '${ip%%//*}//'";;
    "")
	mstsc "$name" $rest;;
    *)
	mstsc "$ip" $rest;;
esac
