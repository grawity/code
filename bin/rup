#!/usr/bin/env bash
# rup -- collect uptime information from multiple hosts
#
# Inspired by the RPC-based 'rup' from SunOS 4 manual.

. lib.bash || exit

usage() {
	echo "Usage: $progname [-H HOSTS]"
}

hosts=$(rlisthosts)
user=

while getopts ":H:S" OPT; do
	case $OPT in
	H) hosts=${OPTARG//,/ };;
	S) user=root@;;
	*) lib::die_getopts;;
	esac
done; shift $((OPTIND-1))

(for host in $hosts; do
	ssh $user$host 'printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n" \
			"$(hostname)" \
			"$(uname -r)" \
			"$(uptime -p | sed "s/^up //; s/,.*//")" \
			"$(uname -v | sed "s/.*/[&]/")" \
			"$(uptime | sed "s/.*load average: //")" \
			"$(free -b | awk "/^Mem:/{printf \"%.0f%% used\", \$3*100/\$2}")" \
			"$(free -b | awk "/^Mem:/{print \$7, \"free\"}" | numfmt --to=iec)" \
			"$(free -b | awk "/^Mem:/{print \$2, \"total\"}" | numfmt --to=iec)" \
			"$(df -h / | awk "NR==2{print \$5, \"used\"}")" \
			"$(df -h / | awk "NR==2{print \$4, \"free\"}")" \
			"$(df -h / | awk "NR==2{print \$2, \"total\"}")" \
			' &
done
wait) |
sort -V -k 2,1 |
column -s $'\t' \
	--table \
	--table-columns "HOST,KERNEL,UPTIME,BUILD,LOAD AVG,MEM,MEM FREE,MEM TOTAL,DISK,DISK FREE,DISK TOTAL" \
	--table-hide "BUILD" \
	--table-right "MEM,MEM FREE,MEM TOTAL,DISK,DISK FREE,DISK TOTAL"
