#!/usr/bin/env bash

. lib.bash || exit

old_head=$1
new_head=$2

[[ $old_head ]] || die "missing old head commit"
[[ $new_head ]] || die "missing new head commit"

old_n=$(git rev-list --count "$old_head")
new_n=$(git rev-list --count "$new_head")

if (( old_n != new_n )); then
	die "history lengths differ ($old_n != $new_n)"
fi

for (( i=0; i<new_n; i++ )); do
	echo -e -n "\rcomparing $old_head~$i <=> $new_head~$i"
	git diff --quiet "$old_head~$i" "$new_head~$i" \
		|| warn "trees of commits $old_head~$i and $new_head~$i differ"
done
echo
info "histories are identical"
