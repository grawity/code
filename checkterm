#!/usr/bin/env bash
# checkterm -- Check whether xterm is being emulated by PuTTY
#
# This is needed for things like Neovim, which strictly adhere to terminfo data
# and do not recognize the (or rather, incorrectly recognize) Home/End keys,
# which PuTTY sends as \e[1~ and \e[4~ whereas terminfo(xterm-256color) says
# khome/kend are \eOH and \eOF respectively.

usage() {
	echo "Usage: ${0##*/} {juicessh|putty}"
}

if (( $# != 1 )); then
	usage >&2
	exit 2
elif [[ $1 != @(juicessh|putty) ]]; then
	echo "${0##*/}: Unknown terminal '$1'" >&2
	exit 2
fi

arg_wanted=$1

if [[ $TERM == @(putty|putty-*) && $arg_wanted == putty ]]; then
	# Shortcut if ~/.bashrc has already changed TERM
	exit 0
elif [[ $TERM != @(xterm|xterm-*) ]]; then
	# Don't bother checking when inside tmux or something else
	exit 1
fi

# Request Secondary DA and Primary DA
stty -echo
printf '\e[>c\e[c'

# TODO: Raw JuiceSSH completely botches Secondary DA and stops parsing at \e[>,
# leading to the 'c' being visible on screen. It might be necessary to query
# Primary DA separately first, and then do the full query again...

if read -r -d '?' -t 2 ans1 && read -r -d 'c' -t 2 ans2; then
	ans="${ans1}?${ans2}c"
	case $ans=$arg_wanted in
		*$'\e[>0;136;0c\e[?6c'=putty)		err=0;;
		*$'\e[>1;10;0c\e[?62c'=juicessh)	err=0;; # actually Mosh
		*$'\e[?1;2c'=juicessh)			err=0;; # real JuiceSSH
		*)					err=1;;
	esac
else
	echo "${0##*/}: Did not receive Primary DA reply from terminal" >&2
	err=4
fi

stty echo
exit $err
