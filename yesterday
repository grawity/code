#!/usr/bin/env bash
# yesterday -- map a file path to latest snapshot
#
# Inspired by the Plan 9 'yesterday' command, and by AFS 'vos backup' (where
# it's common practice to link the backup snapshots into home directories).
#
# https://9fans.github.io/plan9port/man/man1/yesterday.html
# https://computing.help.inf.ed.ac.uk/yesterday

usage() {
	echo "Usage: ${0##*/} <path>"
}

if (( ! $# )); then
	usage
	exit 2
fi

for path; do
	apath=$(realpath "$path")
	if [[ -d $HOME/.old && "$apath/" == "$HOME/"* ]]; then
		base=$HOME
	elif [[ -d /.old ]]; then
		base=/
	else
		echo "${0##*/}: No snapshots on $HOSTNAME" >&2
		exit 1
	fi
	rpath=$(realpath --relative-base="$base" "$path")
	realpath "${base%/}/.old/latest/$rpath"
done
