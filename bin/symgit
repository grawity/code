#!/usr/bin/env bash

. lib.bash || exit

host=star
dir='/srv/git'
prefix=':'

klist -s || kinit || die "no Kerberos credentials"

cmd=$1; shift

case ${cmd:-help} in
	help)
		echo "Commands:"
		echo "  ls|list"
		echo "  new <repo>..."
		echo "  mv|rename <old_repo> <new_repo>"
		echo "  exp|export <repo>..."
		echo "  unexp|unexport <repo>..."
		;;
	ls|list)
		if (( $# )); then
			die "extraneous arguments: '$*'"
		fi
		ssh $host "find '$dir/' -type d -name '*.git' -printf '%P\n' -prune" | sort \
		| sed "s|^|$prefix|; s|\\.git\$||"
		;;
	new)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			url=$prefix${arg%.git}
			if ssh $host "test -d $dir/${arg@Q}"; then
				err "repository '$url' already exists"
				continue
			fi
			info "creating repository '$url'"
			ssh $host "git init --bare $dir/${arg@Q}"
		done
		;;
	mv|move|rename)
		if (( $# != 2 )); then
			die "Usage: $progname $cmd <old> <new>"
		fi
		old=${1%.git}.git; oldu=$prefix${old%.git}
		new=${2%.git}.git; newu=$prefix${new%.git}
		if ! ssh $host "test -d $dir/${old@Q}"; then
			err "source repository '$oldu' does not exist"
		elif ssh $host "test -d $dir/${new@Q}"; then
			err "target repository '$newu' already exists"
		else
			info "renaming repository '$oldu' => '$newu'"
			ssh $host "mv -Tvn $dir/${old@Q} $dir/${new@Q}"
		fi
		;;
	pub|publish|exp|export)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			url=$prefix${arg%.git}
			if ! ssh $host "test -d $dir/${arg@Q}"; then
				err "repository '$url' does not exist"
				continue
			elif ssh $host "test -f $dir/${arg@Q}/git-daemon-export-ok"; then
				info "repository '$url' already public"
				continue
			fi
			info "publishing repository '$url'"
			ssh $host "touch $dir/${arg@Q}/git-daemon-export-ok"
		done
		;;
	unpub|unpublish|unexp|unexport)
		if (( $# < 1 )); then
			die "Usage: $progname $cmd <repo>..."
		fi
		for arg; do
			arg=${arg%.git}.git
			url=$prefix${arg%.git}
			if ! ssh $host "test -d $dir/${arg@Q}"; then
				err "repository '$url' does not exist"
				continue
			elif ! ssh $host "test -f $dir/${arg@Q}/git-daemon-export-ok"; then
				info "repository '$url' not public"
				continue
			fi
			info "unpublishing repository '$url'"
			ssh $host "rm $dir/${arg@Q}/git-daemon-export-ok"
		done
		;;
esac

lib::exit
