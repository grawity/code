#!/usr/bin/env bash

. lib.bash || exit

port_re='\+?[[:digit:]]+'
v6addr_re="^\[(.+)\]:($port_re)$"
host_re="^(.+):($port_re)$"

key=~/.pki/private/auth-grawity.pem

bot=$1 addr=

while read _bot _addr _; do
	if [[ $_bot == "$bot" ]]; then
		addr=$_addr
		break
	fi
done < ~/lib/bots.txt

if [[ ! $addr ]]; then
	die "bot '$bot' unknown"
fi

if [[ $addr =~ $v6addr_re || $addr =~ $host_re ]]; then
	host=${BASH_REMATCH[1]}
	port=${BASH_REMATCH[2]}
else
	die "syntax error in address: $addr"
fi

settitle "$1 (at $host:$port)"

case $port in
	+*)
		port=${port#+}
		if [[ ! -e $key ]]; then
			die "SSL key missing: $key"
		fi
		log "connecting to $host:$port (SSL)"
		exec telnet-ssl -z ssl -z cert="$key" "$host" "$port"
		;;
	*)
		log "connecting to $host:$port (raw)"
		exec telnet "$host" "$port"
		;;
esac
