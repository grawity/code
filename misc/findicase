#!/usr/bin/env python3
from collections import defaultdict
import os
import re
import sys

def bad_win32_name(item):
    if {*item} & {*"?*<>|:\"\n\\"}:
        return True
    elif re.match(r"^(con|prn|aux|nul|com[1-9]|lpt[1-9])$", item.lower()):
        return True
    elif any([ord(c) < 0x20 for c in item]):
        return True
    else:
        return False

roots = sys.argv[1:]

for root in roots:
    seen = defaultdict(set)
    badwin = set()
    total = 0

    for dirpath, dirnames, filenames in os.walk(root):
        for item in [*dirnames, *filenames]:
            path = os.path.join(dirpath, item)
            path = os.path.relpath(path, root)
            cfpath = path.casefold()
            seen[cfpath].add(path)
            if bad_win32_name(item):
                badwin.add(path)
            total += 1

    for cfpath in sorted(seen):
        if len(seen[cfpath]) > 1:
            print("Colliding paths:")
            for ogpath in sorted(seen[cfpath]):
                print("  %s" % ogpath)

    if len(badwin) > 0:
        print("Names incompatible with Windows:")
        for path in sorted(badwin):
            print("  %r" % path)

    print("Scanned %s items with %s unique paths" % (total, len(seen)))
