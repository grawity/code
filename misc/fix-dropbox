#!/usr/bin/env bash
# 2017-xx-xx grawity: this handles launching Dropbox via systemd, as its
# upgrade mechanism doesn't quite work as a service

err() { echo "error: $*" >&2; return 1; }
die() { err "$@"; exit 1; }

dbx-keystore() {
	(. ~/lib/dotfiles/environ && command dbx-keystore "$@");
}

shopt -s nullglob

if [[ ! -d ~/.dropbox-dist ]]; then
	echo "$0: ~/.dropbox-dist missing, looking for staged upgrades"
	dists=(~/.dropbox-dist-tmp-*/
	       ~/.dropbox-dist-old-*/)
	if (( ${#dists[@]} )); then
		echo "$0: found staged upgrades ${dists[*]}, using first"
		mv -v "${dists[0]}" ~/.dropbox-dist || exit
	else
		die "no dropbox-dist found, manual reinstall required"
	fi
fi

rm -rf ~/.dropbox-dist-old-*/

# clean up logs
rm -rf /tmp/dropbox-antifreeze-* >& /dev/null

if [[ $1 == --start ]]; then
	if [[ ! -f ~/.dropbox/instance1/hostkeys ]]; then
		echo "$0: no hostkeys for instance1 yet; continuing"
	elif [[ ! -f ~/.dropbox/hostkeys.json ]]; then
		echo "$0: no hostkeys JSON backup yet; making one"
		dbx-keystore dump || exit
		dbx-keystore dump > ~/.dropbox/hostkeys.json
	elif [[ ~/.dropbox/instance1/hostkeys -nt ~/.dropbox/hostkeys.json ]]; then
		old_keys=$(< ~/.dropbox/hostkeys.json)
		new_keys=$(dbx-keystore dump)
		if [[ "$old_keys" != "$new_keys" ]]; then
			echo "$0: hostkeys JSON backup seems to be invalidated"
			die "full ~/.dropbox restore from backup required"
		else
			touch ~/.dropbox/hostkeys.json
		fi
	else
		old_fsid=$(< ~/.dropbox/fsid_instance1.txt)
		new_fsid=$(stat -fc %i ~/.dropbox/instance1).$(stat -c %i ~/.dropbox/instance1)
		if [[ "$old_fsid" != "$new_fsid" ]]; then
			echo "$0: FSID of ~/.dropbox has changed ($old_fsid -> $new_fsid)"
			echo "$0: restoring hostkeys from JSON backup"
			dbx-keystore load < ~/.dropbox/hostkeys.json &&
				dbx-keystore show > /dev/null 2>&1 ||
					die "hostkey restore failed"
			echo "$new_fsid" > ~/.dropbox/fsid_instance1.txt
		fi
	fi

	arch=x86_64
	vers=$(< ~/.dropbox-dist/VERSION)
	dists=(~/.dropbox-dist/dropbox-lnx.$arch-$vers/
	       ~/.dropbox-dist/dropbox-lnx.$arch-*/)
	for dist in "${dists[@]}"; do
		echo "$0: trying dropboxd in distdir '$dist'"
		exec "$dist"/dropboxd /py3
	done
fi
