#!/usr/bin/env python3
import glob
import re
import subprocess
import sys
import pprint

def enum_subvolumes(root):
    cmd = ["sudo", "btrfs", "subvolume", "list", "-a", root]
    yield (5, 0, "")
    with subprocess.Popen(cmd, stdout=subprocess.PIPE) as proc:
        for line in proc.stdout:
            line = line.decode().strip()
            m = re.match(r"^ID (\d+) gen \d+ top level (\d+) path (.+)$", line)
            subvol_id = int(m.group(1))
            parent_id = int(m.group(2))
            path = m.group(3)
            if path.startswith("<FS_TREE>/"):
                path = path[len("<FS_TREE>/"):]
            yield subvol_id, parent_id, path

args = sys.argv[1:]
if not args:
    args = glob.glob("/run/btrfs/*/")
    args = [arg.rstrip("/") for arg in args]

for i, mtpt in enumerate(args):
    names = {}
    parents = {}

    for subvol_id, parent_id, subvol_name in enum_subvolumes(mtpt):
        names[mtpt, subvol_id] = subvol_name
        parents[mtpt, subvol_id] = parent_id

    if i > 0:
        print()

    cmd = [
        "column",
        "--separator=\t",
        "--table",
        "--table-columns=NAME,ID,PARENT,ABS_ID,ABS_PARENT",
        "--table-order=NAME",
        "--table-hide=ID,PARENT,ABS_ID,ABS_PARENT",
        "--tree=NAME",
        "--tree-id=ID",
        "--tree-parent=PARENT",
    ]

    with subprocess.Popen(cmd, stdin=subprocess.PIPE) as proc:
        for mtpt, subvol_id in names:
            line = [
                names[mtpt, subvol_id] or mtpt,
                subvol_id,
                parents[mtpt, subvol_id],
                "%s@%s" % (mtpt, subvol_id),
                "%s@%s" % (mtpt, parents[mtpt, subvol_id]),
            ]
            line = "\t".join(map(str, line)) + "\n"
            line = line.encode()
            proc.stdin.write(line)
        proc.stdin.close()
